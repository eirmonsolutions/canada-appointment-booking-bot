<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Visa Appointment Scheduler</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<div class="container mx-auto p-4">
  <h1 class="text-3xl font-bold mb-4">Visa Appointment Scheduler</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="space-y-2 mb-4">
        {% for category, message in messages %}
          <div class="px-4 py-3 rounded border
              {{ 'bg-green-50 border-green-300 text-green-800' if category=='success' else
                 'bg-red-50 border-red-300 text-red-800' if category=='error' else
                 'bg-blue-50 border-blue-300 text-blue-800' }}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <a href="{{ url_for('add_user') }}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded mb-4 inline-block">
    Add User
  </a>

  <h2 class="text-2xl font-semibold mb-2">Users</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white border">
      <thead>
        <tr class="bg-gray-50">
          <th scope="col" class="px-4 py-2 border text-left">Username</th>
          <th scope="col" class="px-4 py-2 border text-left">Schedule ID</th>
          <th scope="col" class="px-4 py-2 border text-left">Period</th>
          <th scope="col" class="px-4 py-2 border text-left">Embassy</th>
          <th scope="col" class="px-4 py-2 border text-left">Signed In</th>
          <th scope="col" class="px-4 py-2 border text-left">Saved Session</th>
          <th scope="col" class="px-4 py-2 border text-left">Status</th>
          <th scope="col" class="px-4 py-2 border text-left">Actions</th>
        </tr>
      </thead>
      <tbody>
      {% for user in users %}
        <tr class="odd:bg-white even:bg-gray-50">
          <td class="px-4 py-2 border">{{ user.username }}</td>
          <td class="px-4 py-2 border">{{ user.schedule_id }}</td>
          <td class="px-4 py-2 border">{{ user.period_start }} - {{ user.period_end }}</td>
          <td class="px-4 py-2 border">{{ user.embassy }}</td>
          <td class="px-4 py-2 border">
            {% if user.signed_in_at %}
              <span class="inline-flex items-center px-2 py-0.5 rounded text-sm bg-green-100 text-green-700">Yes</span>
              <div class="text-xs text-gray-500 mt-1">{{ user.signed_in_at }}</div>
            {% else %}
              <span class="inline-flex items-center px-2 py-0.5 rounded text-sm bg-gray-100 text-gray-700">No</span>
            {% endif %}
          </td>
          <td class="px-4 py-2 border">
            {% if user.session_id %}
              <code class="text-sm bg-gray-100 px-2 py-1 rounded">{{ user.session_id[:8] }}••••</code>
            {% else %}
              <span class="text-gray-400 text-sm">None</span>
            {% endif %}
          </td>
          <td class="px-4 py-2 border">
            {% if user.is_active %}
              <span class="inline-flex items-center px-2 py-0.5 rounded text-sm bg-green-100 text-green-700">Active</span>
            {% else %}
              <span class="inline-flex items-center px-2 py-0.5 rounded text-sm bg-gray-100 text-gray-700">Inactive</span>
            {% endif %}
          </td>
          <td class="px-4 py-2 border">
            <form action="{{ url_for('signin_user', user_id=user.id) }}" method="POST" class="inline signin-form">
              <button type="submit" class="px-2 py-1 rounded text-white bg-indigo-600 hover:bg-indigo-700">Sign in & Save</button>
            </form>
            <form action="{{ url_for('toggle_user', user_id=user.id) }}" method="POST" class="inline toggle-form">
              <button type="submit" class="px-2 py-1 rounded text-white {{ 'bg-red-500 hover:bg-red-600' if user.is_active else 'bg-green-600 hover:bg-green-700' }} ml-2">
                {{ 'Stop' if user.is_active else 'Start' }}
              </button>
            </form>
            <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST" class="inline delete-form">
              <button type="submit" class="px-2 py-1 rounded text-white bg-red-500 hover:bg-red-600 ml-2">Delete</button>
            </form>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-semibold mb-2 mt-6">Logs</h2>
  <div id="logs" aria-live="polite" class="bg-white p-4 border rounded max-h-96 overflow-y-auto">
    {% for log in logs | reverse %}
      <p class="mb-2" data-timestamp="{{ log.timestamp }}">
        <span class="font-semibold">{{ log.timestamp }}</span> [{{ log.user }}]: {{ log.message }}
      </p>
    {% endfor %}
  </div>
</div>

<script>
  function formatTimestamp(isoString) {
    const date = new Date(isoString);
    return date.toLocaleString('en-US', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
  }

  function reformatExistingTimestamps() {
    const nodes = document.querySelectorAll('#logs [data-timestamp]');
    nodes.forEach(p => {
      const iso = p.dataset.timestamp;
      const tsEl = p.querySelector('span.font-semibold');
      if (iso && tsEl) tsEl.textContent = formatTimestamp(iso);
    });
  }

  async function fetchLogs() {
    try {
      const response = await fetch('/logs', { cache: 'no-store' });
      const logs = await response.json();
      const logsContainer = document.getElementById('logs');

      const existingKeys = new Set(
        Array.from(logsContainer.querySelectorAll('p')).map(p =>
          (p.dataset.timestamp || '') + '|' + (p.dataset.msghash || '')
        )
      );

      logs.reverse().forEach(log => {
        const key = (log.timestamp || '') + '|' + (log.message || '').slice(0,120);
        if (!existingKeys.has(key)) {
          const p = document.createElement('p');
          p.className = 'mb-2';
          p.dataset.timestamp = log.timestamp;
          p.dataset.msghash = (log.message || '').slice(0,120);
          p.innerHTML = `<span class="font-semibold">${formatTimestamp(log.timestamp)}</span> [${log.user}]: ${log.message}`;
          logsContainer.insertBefore(p, logsContainer.firstChild);
          existingKeys.add(key);
        }
      });

      const items = logsContainer.querySelectorAll('p');
      for (let i = 50; i < items.length; i++) items[i].remove();
    } catch (error) {
      console.error('Error fetching logs:', error);
    }
  }

  // UX: avoid double submits; confirm delete
  document.addEventListener('click', (e) => {
    if (e.target.closest('.toggle-form') || e.target.closest('.signin-form')) {
      const btn = e.target.closest('form').querySelector('button[type="submit"]');
      if (btn) { btn.disabled = true; btn.classList.add('opacity-60','cursor-not-allowed'); }
    }
    if (e.target.closest('.delete-form')) {
      if (!confirm('Delete this user? This cannot be undone.')) e.preventDefault();
    }
  });

  reformatExistingTimestamps();
  fetchLogs();
  setInterval(fetchLogs, 5000);
</script>
</body>
</html>
