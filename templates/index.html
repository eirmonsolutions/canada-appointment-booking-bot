<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>US Visa Appointment Bot</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body {
      display: flex;
      gap: 2rem;
      padding: 1rem;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }

    .sidebar {
      width: 260px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 1rem;
      height: 95vh;
      overflow-y: auto;
    }

    .sidebar h2 {
      font-size: 1.1rem;
      margin-bottom: .8rem;
      color: #333;
    }

    .embassy-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .embassy-list li {
      padding: .5rem .7rem;
      border-bottom: 1px solid #eee;
      font-size: .9rem;
    }

    .embassy-list li span {
      display: block;
      font-size: .8rem;
      color: #666;
    }

    .container {
      flex: 1;
      background: white;
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    #log {
      font-family: monospace;
      background:#f8f8f8;
      padding:1rem;
      height:320px;
      overflow-y:auto;
      border:1px solid #ccc;
      margin-top:1rem;
    }

    .running { color:green; }
    .stopped { color:#777; }

    form label { display:block; margin: .5rem 0; }
    input[type="text"], input[type="password"], input[type="email"] { width:100%; }
  </style>
</head>
<body>

  <!-- Sidebar for embassy list -->
  <div class="sidebar">
    <h2>Embassy Facility List</h2>
    <ul class="embassy-list" id="embassyList"></ul>
  </div>

  <!-- Main content -->
  <div class="container">
    <h1>US Visa Appointment Bot</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flash">
          {% for category, msg in messages %}
            <li class="{{ category }}">{{ msg }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <form method="post" class="cfg-form">
      <label>Email <input name="EMAIL" value="{{ cfg.EMAIL or '' }}" required></label>
      <label>Password <input type="password" name="PASSWORD" value="{{ cfg.PASSWORD or '' }}" required></label>
      <label>Country (2-letter code) <input name="COUNTRY" maxlength="2" value="{{ cfg.COUNTRY or '' }}" required></label>
      <label>Facility ID <input name="FACILITY_ID" value="{{ cfg.FACILITY_ID or '' }}"></label>
      <label>Min date (DD.MM.YYYY) <input name="MIN_DATE" placeholder="01.11.2027" value="{{ cfg.MIN_DATE or '' }}"></label>
      <label>Max date (DD.MM.YYYY) <input name="MAX_DATE" placeholder="30.11.2027" value="{{ cfg.MAX_DATE or '' }}"></label>
      <label>
        <input type="checkbox" name="NEED_ASC" {% if cfg.NEED_ASC == 'True' %}checked{% endif %}>
        Need ASC
      </label>
      <label>ASC Facility ID <input name="ASC_FACILITY_ID" value="{{ cfg.ASC_FACILITY_ID or '' }}"></label>
      <label>Schedule ID <input name="SCHEDULE_ID" value="{{ cfg.SCHEDULE_ID or '' }}"></label>

      <button type="submit" name="action" value="save">Save Config</button>
      <button type="submit" name="action" value="start" class="run">Run Bot</button>
    </form>

    <hr>
    <h3>Live Log <span id="status" class="stopped">(stopped)</span></h3>
    <div id="log"></div>

    <details>
      <summary>Current config (debug)</summary>
      <pre>{{ cfg|pprint }}</pre>
    </details>
  </div>

<script>
  const Embassies = {
    "en-am-yer": ["en-am", 122, "YEREVAN – Armenia"],
    "es-co-bog": ["es-co", 25,  "Bogotá – Colombia"],
    "en-ca-cal": ["en-ca", 89,  "Calgary – Canada"],
    "en-ca-hal": ["en-ca", 90,  "Halifax – Canada"],
    "en-ca-mon": ["en-ca", 91,  "Montreal – Canada"],
    "en-ca-ott": ["en-ca", 92,  "Ottawa – Canada"],
    "en-ca-que": ["en-ca", 93,  "Quebec City – Canada"],
    "en-ca-tor": ["en-ca", 94,  "Toronto – Canada"],
    "en-ca-van": ["en-ca", 95,  "Vancouver – Canada"]
  };

  // populate embassy list
  const embassyList = document.getElementById("embassyList");
  Object.entries(Embassies).forEach(([code, [lang, id, city]]) => {
    const li = document.createElement("li");
    li.innerHTML = `<strong>${city}</strong><span>Code: ${code} | Facility ID: ${id}</span>`;
    embassyList.appendChild(li);
  });

  // log stream
  const logDiv = document.getElementById('log');
  const status = document.getElementById('status');
  const es = new EventSource('/log_stream');
  es.onmessage = e => {
    const line = e.data;
    logDiv.textContent += line + "\n";
    logDiv.scrollTop = logDiv.scrollHeight;
    if (line.includes('Bot started') || line.includes('BOOKED')) status.className = 'running';
    if (line.includes('Bot stopped')) status.className = 'stopped';
  };

  // available dates
  fetch('/available_dates')
    .then(r => r.json())
    .then(dates => {
      if (dates.length) {
        const p = document.createElement('p');
        p.innerHTML = '<strong>Available dates:</strong> ' + dates.join(', ');
        logDiv.parentNode.insertBefore(p, logDiv);
      }
    });
</script>
</body>
</html>
