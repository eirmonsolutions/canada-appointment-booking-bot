<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Visa Appointment Bot</title>
  <style>
    body {font-family: Arial; margin: 20px; background: #f4f4f4;}
    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .form-group {margin: 10px 0;}
    label {display: inline-block; width: 150px;}
    input, select {padding: 8px; width: 250px;}
    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      margin-right: 5px;
    }
    button:hover {background: #0056b3;}
    .user-card {
      border: 1px solid #ddd;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .logs {
      margin-top: 10px;
      padding: 10px;
      background: #eee;
      height: 150px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .success {color: green; font-weight: bold;}
    .error {color: red; font-weight: bold;}
  </style>
</head>
<body>
  <div class="container">
    <h1>US Visa Appointment Booker</h1>
    <div id="users"></div>
    <button onclick="addUserForm()">+ Add User</button>
    <hr/>
    <h2>Global Logs</h2>
    <pre id="global-logs" class="logs"></pre>
  </div>

  <script>
   function toDDMMYYYY(iso) {
  return iso; // just send "2027-01-12"
}
    const Embassies = {
      "en-ca-cal": ["en-ca", 89, "Continue"],
      "en-ca-hal": ["en-ca", 90, "Continue"],
      "en-ca-mon": ["en-ca", 91, "Continue"],
      "en-ca-ott": ["en-ca", 92, "Continue"],
      "en-ca-que": ["en-ca", 93, "Continue"],
      "en-ca-tor": ["en-ca", 94, "Continue"],
      "en-ca-van": ["en-ca", 95, "Continue"]
    };

    function embassyOptions() {
      return Object.keys(Embassies).map(key => {
        const pretty = key.toUpperCase().replace(/-/g, ' - ');
        return `<option value="${key}">${pretty}</option>`;
      }).join('');
    }

    let userCount = 0;

    function addUserForm() {
      userCount++;
      const div = document.createElement("div");
      div.className = "user-card";
      div.id = `user-${userCount}`;
      div.innerHTML = `
        <h3>User ${userCount}</h3>
        <div class="form-group"><label>Email:</label><input type="text" class="username"/></div>
        <div class="form-group"><label>Password:</label><input type="password" class="password"/></div>
        <div class="form-group"><label>Schedule ID:</label><input type="text" class="schedule_id"/></div>
        <div class="form-group"><label>Embassy:</label>
          <select class="embassy">${embassyOptions()}</select>
        </div>
        <div class="form-group"><label>Period Start:</label><input type="date" class="period_start"/></div>
        <div class="form-group"><label>Period End:</label><input type="date" class="period_end"/></div>
        <button onclick="startBot(${userCount})">Start Bot</button>
        <button onclick="stopBot(${userCount})" disabled>Stop Bot</button>
        <button onclick="this.parentElement.remove()">Remove</button>
        <div class="logs" id="log-${userCount}"></div>
      `;
      document.getElementById("users").appendChild(div);
    }

    function startBot(id) {
      const card = document.getElementById(`user-${id}`);
      const data = {
        username: card.querySelector(".username").value.trim(),
        password: card.querySelector(".password").value,
        schedule_id: card.querySelector(".schedule_id").value.trim(),
        embassy: card.querySelector(".embassy").value,
        period_start: toDDMMYYYY(card.querySelector(".period_start").value),
        period_end: toDDMMYYYY(card.querySelector(".period_end").value)
      };

      if (!data.username || !data.password || !data.schedule_id) {
        alert("Email, Password and Schedule ID are required");
        return;
      }

      fetch("/start", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
      })
      .then(r => r.json())
      .then(res => {
        logGlobal(`Bot #${res.user_id} started for ${data.username}`);
        card.querySelector("button[onclick^=startBot]").disabled = true;
        card.querySelector("button[onclick^=stopBot]").disabled = false;
      })
      .catch(err => logGlobal(`ERROR starting bot: ${err}`));
    }

    function stopBot(id) {
      fetch(`/stop/${id}`, {method: "POST"})
        .then(() => {
          logGlobal(`Bot #${id} stopped`);
          const card = document.getElementById(`user-${id}`);
          card.querySelector("button[onclick^=startBot]").disabled = false;
          card.querySelector("button[onclick^=stopBot]").disabled = true;
        });
    }

    function logGlobal(msg, color = "#000") {
  const log = document.getElementById("global-logs");
  const span = document.createElement("span");
  span.style.color = color;
  span.textContent = msg + "\n";
  log.appendChild(span);
  log.scrollTop = log.scrollHeight;
}

    const evtSource = new EventSource("/log_stream");
    console.log("Listening to log stream...",evtSource);
   evtSource.onmessage = e => {
  const [uid, line] = e.data.split("|", 2);
  const colors = ["#007bff", "#28a745", "#ff6600", "#800080"];
  const color = colors[parseInt(uid) % colors.length] || "#000";
  logGlobal(`[User ${uid}] ${line}`, color);

  const logDiv = document.getElementById(`log-${uid}`);
  if (logDiv) {
    logDiv.textContent += line + "\n";
    logDiv.scrollTop = logDiv.scrollHeight;
  }
};



    window.onload = () => addUserForm();
  </script>
</body>
</html>
