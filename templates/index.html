<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Visa Appointment Bot – Multi-User</title>
  <style>
    body {font-family: Arial; margin:20px; background:#f4f4f4;}
    .container {max-width:960px; margin:auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,.1);}
    .form-group {margin:10px 0;}
    label {display:inline-block; width:150px;}
    input, select {padding:8px; width:250px;}
    button {padding:8px 16px; margin-right:5px; cursor:pointer;}
    .user-card {border:1px solid #ddd; padding:15px; margin:15px 0; border-radius:8px; background:#fafafa;}
    .logs {margin-top:10px; padding:10px; background:#eee; height:180px; overflow-y:auto; font-family:monospace; font-size:12px;}
    .success {color:green; font-weight:bold;}
    .error   {color:red;   font-weight:bold;}
  </style>
</head>
<body>
  <div class="container">
    <h1>US Visa Appointment Booker – Multi-User</h1>
    <div id="users"></div>
    <button onclick="addUser()">+ Add User</button>
    <hr/>
    <h2>Global Log</h2>
    <pre id="global-logs" class="logs"></pre>
  </div>

  <script>
    const EMBASSIES = {
      "en-ca-cal": "Canada – Calgary",
      "en-ca-hal": "Canada – Halifax",
      "en-ca-mon": "Canada – Montreal",
      "en-ca-ott": "Canada – Ottawa",
      "en-ca-que": "Canada – Quebec",
      "en-ca-tor": "Canada – Toronto",
      "en-ca-van": "Canada – Vancouver"
    };

    let userCounter = 0;

    function embassyOptions(selected = "en-ca-tor") {
  return Object.entries(EMBASSIES).map(([k, v]) => 
    `<option value="${k}" ${k === selected ? 'selected' : ''}>${v}</option>`
  ).join('');
}

    function addUser() {
      userCounter++;
      const div = document.createElement("div");
      div.className = "user-card";
      div.id = `user-${userCounter}`;
      div.innerHTML = `
        <h3>User ${userCounter}</h3>
        <div class="form-group"><label>Email:</label><input type="email" class="email" required/></div>
        <div class="form-group"><label>Password:</label><input type="password" class="password" required/></div>
        <div class="form-group"><label>Schedule ID:</label><input type="text" class="schedule_id" required/></div>
        <div class="form-group"><label>Embassy:</label>
          <select class="embassy">${embassyOptions()}</select>
        </div>
        <div class="form-group"><label>Period Start:</label><input type="date" class="period_start" required/></div>
        <div class="form-group"><label>Period End:</label><input type="date" class="period_end"/></div>

        <button onclick="startBot('${userCounter}')">Start Bot</button>
        <button onclick="stopBot('${userCounter}')" disabled>Stop Bot</button>
        <button onclick="this.parentElement.remove()">Remove</button>

        <div class="logs" id="log-${userCounter}"></div>
      `;
      document.getElementById("users").appendChild(div);
    }

    function startBot(cardId) {
      const card = document.getElementById(`user-${cardId}`);
      const email = card.querySelector(".email").value.trim();
      const data = {
        username: email,
        password: card.querySelector(".password").value,
        schedule_id: card.querySelector(".schedule_id").value.trim(),
        embassy: card.querySelector(".embassy").value,
        period_start: card.querySelector(".period_start").value,
        period_end: card.querySelector(".period_end").value || null
      };

      if (!email || !data.password || !data.schedule_id) {
        alert("Email, Password and Schedule ID are required");
        return;
      }

      fetch("/start", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
      })
      .then(r => r.json())
      .then(res => {
        if (res.error) { alert(res.error); return; }
        card.querySelector("button[onclick^=startBot]").disabled = true;
        card.querySelector("button[onclick^=stopBot]").disabled = false;
        logGlobal(`[${email}] Bot STARTED`);
      })
      .catch(err => logGlobal(`[${email}] ERROR: ${err}`));
    }

    function stopBot(cardId) {
      const card = document.getElementById(`user-${cardId}`);
      const email = card.querySelector(".email").value.trim();

      fetch(`/stop/${encodeURIComponent(email)}`, {method: "POST"})
        .then(() => {
          card.querySelector("button[onclick^=startBot]").disabled = false;
          card.querySelector("button[onclick^=stopBot]").disabled = true;
          logGlobal(`[${email}] Bot STOPPED`);
        });
    }

    function logGlobal(msg, color = "#000") {
      const log = document.getElementById("global-logs");
      const line = document.createElement("div");
      line.style.color = color;
      line.textContent = msg;
      log.appendChild(line);
      log.scrollTop = log.scrollHeight;
    }

    const evt = new EventSource("/log_stream");
    evt.onmessage = e => {
      const [prefix, line] = e.data.split("|", 2);
      const colors = ["#007bff", "#28a745", "#ff6600", "#d63384", "#6f42c1"];
      const color = colors[prefix.split("@")[0].length % colors.length] || "#000";

      logGlobal(`[${prefix}] ${line}`, color);

      const userPane = document.getElementById(`log-${prefix}`);
      if (userPane) {
        const span = document.createElement("div");
        span.textContent = line;
        userPane.appendChild(span);
        userPane.scrollTop = userPane.scrollHeight;
      }
    };

    window.onload = () => addUser();
  </script>
</body>
</html>